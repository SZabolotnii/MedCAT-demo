# Value-Aware Linking Improvement Plan

## 1. Проблема
- Ключове слово `heart~rate` мапиться на кілька CUI (`5B51B989ADA20C282C2487DA`, `5F59DFE25786951388090907` тощо).
- Лінкер відкидає всі кандидати: `context_similarity = -1` через відсутність тренувальних векторів.
- CDB містить метадані у `data/internal.csv`: `keyword_hints`, `data_value`, `data_hints`, ознаки належності до кластерів із числовими параметрами.

## 2. Цілі
1. Забезпечити коректне вилучення `Heart Rate` з числовими значеннями та `Heart Rate Level` з якісними дескрипторами.
2. Зменшити двозначність для інших подібних концептів (проблеми/симптоми, числові вимірювання).
3. Інтегрувати значення-хінти (value hints) у пайплайн MedCAT без регресій.

## 3. План дій

### Етап A. Швидке покращення (1–2 дні)
1. **Rule-based пост-обробка у `CustomCAT`:**
   - Після виклику `cat.get_entities()` перевіряти кожен `entity`.
   - Витягувати підрядкові значення з тексту згідно з патернами з `data/internal.csv`.
   - **Жорстке правило:** за замовчуванням кожен CUI потребує value-хінта. Винятки беруться з `data/hc.yaml` (`ft_value_without_hint_by_keyword`, `ft_value_without_hint_by_cluster`). Для числових концептів додатково перевіряємо діапазони з `data/numerical_model.json`. Комбіновані ключові слова (наприклад, `aspirin / dipyridamole`) вимагають наявності всіх складових у тексті, щоб уникнути часткових збігів.
   - Якщо кластер позначений як числовий, залишати CUI для базового виміру (`Heart Rate`) тільки коли поруч знайдено числове значення; якщо ні — повертати сутність із якісною ознакою (`Heart Rate Level`).
2. **Автоматизовані юніт‑тести:**
   - Додати тест у `tests/test_entity_detection.py` для кейсів з `120` та `high`.
3. **Оновити документацію (`README`, `TESTING_INSTRUCTION.md`):**
   - Коротко описати rule-based шари та як їх налаштовувати через CSV.

### Етап B. Дані для контекстних векторів (1–2 тижні)
1. **Генерація синтетичних корпусів:**
   - Парсити `data/internal.csv` й формувати речення виду `"{keyword} {value}"`.
   - Використовувати комбіновані шаблони для чисел (`{keyword} is {value}`) та якісних значень (`{keyword} is high`).
2. **Донавчання контекстної моделі:**
   - Запустити `cat.train_supervised`/`cat.train_unsupervised` на згенерованому корпусі.
   - Переконатися, що `cui2info[...]` заповнився `context_vectors`.
3. **Повернути `similarity_threshold` до 1.0:**
   - Валідувати, що MedCAT тепер лінкує правильний CUI без rule-based логіки (але залишити її як запасний варіант).
4. **Метрики:**
   - Додати розділ у `reports/validation_suite.json` про покращення точності на value-aware сценаріях.

### Етап C. Повноцінний value-aware шар (3–4 тижні)
1. **Value Hint Resolver:**
   - Створити окремий модуль у `src/` (напр., `value_resolver.py`), що інкапсулює роботу з `data/internal.csv` та `data/numerical_model.json`.
   - API: `resolve(keyword, text_span) -> Dict[CUI, weight]`, складаючи оцінку на основі знайдених чисел/токенів (валідація діапазонів згідно `numerical_model.json`) і вже на цьому рівні застосовуючи правило “кластери з `String`/числовими значеннями → обов’язкові value-хінти”.
2. **Інтеграція з Combined Hints:**
   - Для числових кластерів генерувати комбіновані патерни (regex) автоматично.
   - Для нечислових симптомів — дозволяти ручні текстові хінти (як зараз у `internal_combined_hints.json`).
3. **Конфігурація:**
   - Додати прапорець у `CustomCAT` (`use_value_resolver=True`), щоб сервісно керувати новою логікою.
4. **CI та контроль якості:**
   - Тримати правило та ML-вирішення паралельно; при успішному навчанні поступово вимикати rule-based fallback.
5. **Документація & підтримка:**
   - Описати формат CSV (перелік колонок, зокрема `data_value`, `data_hints`, `cluster_title`).
   - Додати сценарії використання у `TESTING_METHODOLOGY.md`.

## 4. Ризики та мітигація
- **Неповні значення в CSV:** передбачити валідацію; некоректні записи ігнорувати.
- **Псевдоспрацювання числових regexів:** ставити обмеження на діапазони (наприклад, `0–250` для `Heart Rate`).
- **Регресії NER:** підтримувати окремі тести для симптомів без value (метастази, біль тощо).
- **Витрати часу на навчання:** автоматизувати генерацію синтетичного корпусу, зберігати артефакти в `data/generated/`.

## 5. Очікувані результати
- Сутності з числовими та якісними ознаками лінкуються до правильних CUI.
- `reports/validation_suite.json` фіксує F1 ≥ 0.78 на кейсах із value hints.
- План готовий до масштабування на інші кластери (артеріальний тиск, температура тощо).
